# Speedtest Logger - Docker Compose Configuration
#
# Verwendung:
#   docker-compose up -d       # Startet alle Services
#   docker-compose logs -f     # Zeigt Logs an
#   docker-compose down        # Stoppt alle Services
#
# Die Web-Oberfläche ist erreichbar unter: http://192.168.0.2:3000
# Die API ist erreichbar unter: http://192.168.0.2:3001

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: speedtest-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DB_USER:-speedtest}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-speedtest}
      POSTGRES_DB: ${DB_NAME:-speedtest}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U speedtest"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - speedtest-network

  # Backend API + Speedtest Scheduler
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: speedtest-backend
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://${DB_USER:-speedtest}:${DB_PASSWORD:-speedtest}@postgres:5432/${DB_NAME:-speedtest}?schema=public
      PORT: "3001"
      HOST: "0.0.0.0"
      # Cron-Expression: Standard ist alle 5 Minuten
      SPEEDTEST_CRON: ${SPEEDTEST_CRON:-*/5 * * * *}
      # Speedtest beim Start ausführen
      RUN_ON_STARTUP: ${RUN_ON_STARTUP:-true}
      # CORS erlauben (für Frontend)
      CORS_ORIGIN: "*"
    ports:
      - "${BACKEND_PORT:-3001}:3001"
    volumes:
      - exports_data:/app/backend/exports
    networks:
      - speedtest-network

  # Frontend React App (SPA served via nginx)
  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
      # VITE_API_URL wird NICHT gesetzt - Frontend erkennt API automatisch
      # basierend auf window.location.hostname (funktioniert im LAN)
    container_name: speedtest-frontend
    restart: unless-stopped
    depends_on:
      - backend
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    networks:
      - speedtest-network

volumes:
  postgres_data:
  exports_data:

networks:
  speedtest-network:
    driver: bridge
